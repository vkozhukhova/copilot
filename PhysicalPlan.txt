== Physical Plan ==
Execute InsertIntoHadoopFsRelationCommand s3a://yac-sb-gen-rupn-ct-00002-20231005150509504400000001/application/control_towers/cpfr/datamarts/open_orders/main_page/partition_division=petcare, false, Parquet, [path=s3a://yac-sb-gen-rupn-ct-00002-20231005150509504400000001/application/control_towers/cpfr/datamarts/open_orders/main_page/partition_division=petcare/], Overwrite, [Customer, CustomerProductId, Division, MarsDc, CustomerDc, CustomerDcCode, Promo, MarsWeekFullName, MarsWeekRollingNum, MarsDay, Region, Brand, Subbrand, Technology, LsvOrdered, LsvConfirmed, LsvPreSl, LsvPreUnderdeliver, CsOrdered, CsConfirmed, CsPreSl, CsPreUnderdeliver, UnitsOrdered, UnitsConfirmed, ... 36 more fields]
+- *(81) Project [Customer#0, CustomerProductId#1, Division#2, MarsDc#3, CustomerDc#4, CustomerDcCode#5, false AS Promo#7074, MarsWeekFullName#6, MarsWeekRollingNum#7, MarsDay#10, Region#11, Brand#1149, concat_ws( , Brand#1149, Technology#12) AS Subbrand#7063, Technology#12, LsvOrdered#13, LsvConfirmed#14, LsvPreSl#15, LsvPreUnderdeliver#16, CsOrdered#17, CsConfirmed#18, CsPreSl#19, CsPreUnderdeliver#20, UnitsOrdered#21, UnitsConfirmed#22, ... 36 more fields]
   +- *(81) BroadcastHashJoin [Material#30], [MATERIAL#1144], LeftOuter, BuildRight
      :- *(81) Project [Customer#0, CustomerProductId#1, Division#2, MarsDc#3, CustomerDc#4, CustomerDcCode#5, MarsWeekFullName#6, MarsWeekRollingNum#7, MarsDay#10, Region#11, Technology#12, LsvOrdered#13, LsvConfirmed#14, LsvPreSl#15, LsvPreUnderdeliver#16, CsOrdered#17, CsConfirmed#18, CsPreSl#19, CsPreUnderdeliver#20, UnitsOrdered#21, UnitsConfirmed#22, UnitsPreSl#23, UnitsPreUnderdeliver#24, FactPlanBillingDate#25, ... 36 more fields]
      :  +- *(81) BroadcastHashJoin [Material#30, Customer#0], [Alert4_Material#4677, Alert4_Customer#4678], LeftOuter, BuildRight, ((Allocation#53 = true) AND (AllocationAvailable#54 = 0.0))
      :     :- *(81) Project [Customer#0, CustomerProductId#1, Division#2, MarsDc#3, CustomerDc#4, CustomerDcCode#5, MarsWeekFullName#6, MarsWeekRollingNum#7, MarsDay#10, Region#11, Technology#12, LsvOrdered#13, LsvConfirmed#14, LsvPreSl#15, LsvPreUnderdeliver#16, CsOrdered#17, CsConfirmed#18, CsPreSl#19, CsPreUnderdeliver#20, UnitsOrdered#21, UnitsConfirmed#22, UnitsPreSl#23, UnitsPreUnderdeliver#24, FactPlanBillingDate#25, ... 34 more fields]
      :     :  +- SortMergeJoin [SalesOrderId#38, Material#30, SoldTo#9], [A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753], LeftOuter
      :     :     :- *(69) Sort [SalesOrderId#38 ASC NULLS FIRST, Material#30 ASC NULLS FIRST, SoldTo#9 ASC NULLS FIRST], false, 0
      :     :     :  +- Exchange hashpartitioning(SalesOrderId#38, Material#30, SoldTo#9, 32), true, [id=#2124]
      :     :     :     +- *(68) Project [Customer#0, CustomerProductId#1, Division#2, MarsDc#3, CustomerDc#4, CustomerDcCode#5, MarsWeekFullName#6, MarsWeekRollingNum#7, SoldTo#9, MarsDay#10, Region#11, Technology#12, LsvOrdered#13, LsvConfirmed#14, LsvPreSl#15, LsvPreUnderdeliver#16, CsOrdered#17, CsConfirmed#18, CsPreSl#19, CsPreUnderdeliver#20, UnitsOrdered#21, UnitsConfirmed#22, UnitsPreSl#23, UnitsPreUnderdeliver#24, ... 33 more fields]
      :     :     :        +- SortMergeJoin [Material#30, PositionNumber#40, MarsDc#3, SalesOrderId#38], [Material#5341, PositionNumber#5351, MarsDc#5314, SalesOrderId#5349], LeftOuter
      :     :     :           :- *(50) Sort [Material#30 ASC NULLS FIRST, PositionNumber#40 ASC NULLS FIRST, MarsDc#3 ASC NULLS FIRST, SalesOrderId#38 ASC NULLS FIRST], false, 0
      :     :     :           :  +- Exchange hashpartitioning(Material#30, PositionNumber#40, MarsDc#3, SalesOrderId#38, 32), true, [id=#1829]
      :     :     :           :     +- *(49) Project [Customer#0, CustomerProductId#1, Division#2, MarsDc#3, CustomerDc#4, CustomerDcCode#5, MarsWeekFullName#6, MarsWeekRollingNum#7, SoldTo#9, MarsDay#10, Region#11, Technology#12, LsvOrdered#13, LsvConfirmed#14, LsvPreSl#15, LsvPreUnderdeliver#16, CsOrdered#17, CsConfirmed#18, CsPreSl#19, CsPreUnderdeliver#20, UnitsOrdered#21, UnitsConfirmed#22, UnitsPreSl#23, UnitsPreUnderdeliver#24, ... 31 more fields]
      :     :     :           :        +- SortMergeJoin [SalesOrderId#38], [SalesOrderId#5010], LeftOuter
      :     :     :           :           :- *(10) Sort [SalesOrderId#38 ASC NULLS FIRST], false, 0
      :     :     :           :           :  +- Exchange hashpartitioning(SalesOrderId#38, 32), true, [id=#1246]
      :     :     :           :           :     +- *(9) Project [Customer#0, CustomerProductId#1, Division#2, MarsDc#3, CustomerDc#4, CustomerDcCode#5, MarsWeekFullName#6, MarsWeekRollingNum#7, SoldTo#9, MarsDay#10, Region#11, Technology#12, LsvOrdered#13, LsvConfirmed#14, LsvPreSl#15, LsvPreUnderdeliver#16, CsOrdered#17, CsConfirmed#18, CsPreSl#19, CsPreUnderdeliver#20, UnitsOrdered#21, UnitsConfirmed#22, UnitsPreSl#23, UnitsPreUnderdeliver#24, ... 31 more fields]
      :     :     :           :           :        +- SortMergeJoin [Material#30, PurchaseOrderId#39], [MATERIAL_CODE#1795, PurchaseOrderId#2436], LeftOuter
      :     :     :           :           :           :- *(2) Sort [Material#30 ASC NULLS FIRST, PurchaseOrderId#39 ASC NULLS FIRST], false, 0
      :     :     :           :           :           :  +- Exchange hashpartitioning(Material#30, PurchaseOrderId#39, 32), true, [id=#1198]
      :     :     :           :           :           :     +- *(1) ColumnarToRow
      :     :     :           :           :           :        +- FileScan parquet [Customer#0,CustomerProductId#1,Division#2,MarsDc#3,CustomerDc#4,CustomerDcCode#5,MarsWeekFullName#6,MarsWeekRollingNum#7,SoldTo#9,MarsDay#10,Region#11,Technology#12,LsvOrdered#13,LsvConfirmed#14,LsvPreSl#15,LsvPreUnderdeliver#16,CsOrdered#17,CsConfirmed#18,CsPreSl#19,CsPreUnderdeliver#20,UnitsOrdered#21,UnitsConfirmed#22,UnitsPreSl#23,UnitsPreUnderdeliver#24,... 27 more fields] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00003-20230411131136265600000002/application/control..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct<Customer:string,CustomerProductId:string,Division:string,MarsDc:string,CustomerDc:string,C...
      :     :     :           :           :           +- *(8) Sort [MATERIAL_CODE#1795 ASC NULLS FIRST, PurchaseOrderId#2436 ASC NULLS FIRST], false, 0
      :     :     :           :           :              +- *(8) Project [MATERIAL_CODE#1795, PurchaseOrderId#2436, FlagPriceDisagreement#2451, Переразместить/скорректировать цену.
 AS AlertPriceDisagreement#2457]
      :     :     :           :           :                 +- *(8) Filter (isnotnull(FlagPriceDisagreement#2451) AND (FlagPriceDisagreement#2451 = 1))
      :     :     :           :           :                    +- *(8) HashAggregate(keys=[MATERIAL_CODE#1795, BSTNK#717], functions=[max(FlagPriceDisagreement#2422)], output=[MATERIAL_CODE#1795, PurchaseOrderId#2436, FlagPriceDisagreement#2451])
      :     :     :           :           :                       +- Exchange hashpartitioning(MATERIAL_CODE#1795, BSTNK#717, 32), true, [id=#1235]
      :     :     :           :           :                          +- *(7) HashAggregate(keys=[MATERIAL_CODE#1795, BSTNK#717], functions=[partial_max(FlagPriceDisagreement#2422)], output=[MATERIAL_CODE#1795, BSTNK#717, max#7248])
      :     :     :           :           :                             +- *(7) Project [MATERIAL_CODE#1795, BSTNK#717, CASE WHEN (cast(round(abs(CheckOverflow((promote_precision(cast(CheckOverflow((promote_precision(CheckOverflow((promote_precision(cast(abs(KZWI3#750) as decimal(27,9))) / promote_precision(abs(CheckOverflow((promote_precision(CheckOverflow((promote_precision(KWMENG#747) * promote_precision(cast(UMVKZ#787 as decimal(15,3)))), DecimalType(21,3), true)) / promote_precision(cast(UMVKN#786 as decimal(21,3)))), DecimalType(27,9), true)))), DecimalType(38,18), true)) / promote_precision(cast(cast(coalesce(UOM_PC2Case#1171, 1) as decimal(10,0)) as decimal(38,18)))), DecimalType(38,18), true) as decimal(38,17))) - promote_precision(cast(abs(NETPR#767) as decimal(38,17)))), DecimalType(38,17), true)), 4) as double) > 0.02) THEN 1 ELSE 0 END AS FlagPriceDisagreement#2422]
      :     :     :           :           :                                +- *(7) BroadcastHashJoin [MATERIAL_CODE#1795], [MATERIAL#1144], LeftOuter, BuildRight
      :     :     :           :           :                                   :- *(7) Project [MATERIAL_CODE#1795, BSTNK#717, KWMENG#747, UMVKZ#787, UMVKN#786, KZWI3#750, NETPR#767]
      :     :     :           :           :                                   :  +- *(7) BroadcastHashJoin [cast(VBELN#686 as bigint), cast(POSNR#689 as int)], [SALESORDERID#308L, POSITION_NUMBER#310], Inner, BuildRight
      :     :     :           :           :                                   :     :- *(7) Project [VBELN#686, POSNR#689, regexp_replace(MATNR#758, ^[0]*, ) AS MATERIAL_CODE#1795, BSTNK#717, KWMENG#747, UMVKZ#787, UMVKN#786, KZWI3#750, NETPR#767]
      :     :     :           :           :                                   :     :  +- *(7) Filter (((((((isnotnull(VKORG#713) AND isnotnull(SPART#780)) AND (cast(VKORG#713 as int) = 261)) AND (cast(SPART#780 as int) = 5)) AND isnotnull(VBELN#686)) AND isnotnull(POSNR#689)) AND isnotnull(regexp_replace(MATNR#758, ^[0]*, ))) AND isnotnull(BSTNK#717))
      :     :     :           :           :                                   :     :     +- *(7) ColumnarToRow
      :     :     :           :           :                                   :     :        +- FileScan parquet [VBELN#686,POSNR#689,VKORG#713,BSTNK#717,KWMENG#747,KZWI3#750,MATNR#758,NETPR#767,SPART#780,UMVKN#786,UMVKZ#787] Batched: true, DataFilters: [isnotnull(VKORG#713), isnotnull(SPART#780), (cast(VKORG#713 as int) = 261), (cast(SPART#780 as i..., Format: Parquet, Location: TahoeLogFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/distilled/atlas/z2l..., PartitionFilters: [], PushedFilters: [IsNotNull(VKORG), IsNotNull(SPART), IsNotNull(VBELN), IsNotNull(POSNR), IsNotNull(BSTNK)], ReadSchema: struct<VBELN:string,POSNR:string,VKORG:string,BSTNK:string,KWMENG:decimal(15,3),KZWI3:decimal(13,...
      :     :     :           :           :                                   :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, bigint, true], input[1, int, true])), [id=#1211]
      :     :     :           :           :                                   :        +- *(3) Project [SALESORDERID#308L, POSITION_NUMBER#310]
      :     :     :           :           :                                   :           +- *(3) Filter (((((isnotnull(GISTATUS#333) AND (NOT REJECTIONREASON_TYPE#340 IN (GOOD,DELETED) OR isnull(REJECTIONREASON_TYPE#340))) AND SALESORDERTYPE#313 IN (ZIC1,ZOR)) AND NOT GISTATUS#333) AND isnotnull(SALESORDERID#308L)) AND isnotnull(POSITION_NUMBER#310))
      :     :     :           :           :                                   :              +- *(3) ColumnarToRow
      :     :     :           :           :                                   :                 +- FileScan parquet [SALESORDERID#308L,POSITION_NUMBER#310,SALESORDERTYPE#313,GISTATUS#333,REJECTIONREASON_TYPE#340,FACT_DATE_RETROSPECTIVE#365] Batched: true, DataFilters: [isnotnull(GISTATUS#333), (NOT REJECTIONREASON_TYPE#340 IN (GOOD,DELETED) OR isnull(REJECTIONREAS..., Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/core/so..., PartitionFilters: [], PushedFilters: [IsNotNull(GISTATUS), Or(Not(In(REJECTIONREASON_TYPE, [GOOD,DELETED])),IsNull(REJECTIONREASON_TYP..., ReadSchema: struct<SALESORDERID:bigint,POSITION_NUMBER:int,SALESORDERTYPE:string,GISTATUS:boolean,REJECTIONRE...
      :     :     :           :           :                                   +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true])), [id=#1229]
      :     :     :           :           :                                      +- *(6) Project [MATERIAL#1144, UOM_PC2Case#1171]
      :     :     :           :           :                                         +- *(6) Filter (isnotnull(rn#1586) AND (rn#1586 = 1))
      :     :     :           :           :                                            +- Window [row_number() windowspecdefinition(MATERIAL#1144, START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#1586], [MATERIAL#1144], [START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST]
      :     :     :           :           :                                               +- *(5) Sort [MATERIAL#1144 ASC NULLS FIRST, START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST], false, 0
      :     :     :           :           :                                                  +- Exchange hashpartitioning(MATERIAL#1144, 32), true, [id=#1220]
      :     :     :           :           :                                                     +- *(4) Project [VMSTD#1139, 0CREATEDON#1140, MATERIAL#1144, UOM_PC2Case#1171, START_DATE#1172]
      :     :     :           :           :                                                        +- *(4) Filter isnotnull(MATERIAL#1144)
      :     :     :           :           :                                                           +- *(4) ColumnarToRow
      :     :     :           :           :                                                              +- FileScan parquet [VMSTD#1139,0CREATEDON#1140,MATERIAL#1144,UOM_PC2Case#1171,START_DATE#1172] Batched: true, DataFilters: [isnotnull(MATERIAL#1144)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/domain_..., PartitionFilters: [], PushedFilters: [IsNotNull(MATERIAL)], ReadSchema: struct<VMSTD:string,0CREATEDON:string,MATERIAL:string,UOM_PC2Case:int,START_DATE:date>
      :     :     :           :           +- *(48) Sort [SalesOrderId#5010 ASC NULLS FIRST], false, 0
      :     :     :           :              +- *(48) HashAggregate(keys=[SalesOrderId#5010, CsPreSlSalesOrder#3692], functions=[], output=[SalesOrderId#5010])
      :     :     :           :                 +- *(48) HashAggregate(keys=[SalesOrderId#5010, knownfloatingpointnormalized(normalizenanandzero(CsPreSlSalesOrder#3692)) AS CsPreSlSalesOrder#3692], functions=[], output=[SalesOrderId#5010, CsPreSlSalesOrder#3692])
      :     :     :           :                    +- *(48) Project [SalesOrderId#5010, CsPreSlSalesOrder#3692]
      :     :     :           :                       +- *(48) Filter (isnotnull(RnCountCasesDonorPlantGreatest#3768) AND (RnCountCasesDonorPlantGreatest#3768 = 1))
      :     :     :           :                          +- Window [dense_rank(CountCasesDonorPlantGreatest#3760L) windowspecdefinition(SalesOrderId#5010, CountCasesDonorPlantGreatest#3760L DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS RnCountCasesDonorPlantGreatest#3768], [SalesOrderId#5010], [CountCasesDonorPlantGreatest#3760L DESC NULLS LAST]
      :     :     :           :                             +- *(47) Sort [SalesOrderId#5010 ASC NULLS FIRST, CountCasesDonorPlantGreatest#3760L DESC NULLS LAST], false, 0
      :     :     :           :                                +- *(47) HashAggregate(keys=[SalesOrderId#5010, CsPreSlSalesOrder#3692, MarsDc#4975, DonorPlant#2933], functions=[sum(cast(rn#3716 as bigint))], output=[SalesOrderId#5010, CsPreSlSalesOrder#3692, CountCasesDonorPlantGreatest#3760L])
      :     :     :           :                                   +- *(47) HashAggregate(keys=[SalesOrderId#5010, knownfloatingpointnormalized(normalizenanandzero(CsPreSlSalesOrder#3692)) AS CsPreSlSalesOrder#3692, MarsDc#4975, DonorPlant#2933], functions=[partial_sum(cast(rn#3716 as bigint))], output=[SalesOrderId#5010, CsPreSlSalesOrder#3692, MarsDc#4975, DonorPlant#2933, sum#7250L])
      :     :     :           :                                      +- *(47) Project [SalesOrderId#5010, MarsDc#4975, DonorPlant#2933, CsPreSlSalesOrder#3692, rn#3716]
      :     :     :           :                                         +- *(47) Filter (isnotnull(rn#3716) AND (rn#3716 = 1))
      :     :     :           :                                            +- Window [row_number() windowspecdefinition(SalesOrderId#5010, Material#5002, FREE_STOCK#216 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#3716], [SalesOrderId#5010, Material#5002], [FREE_STOCK#216 DESC NULLS LAST]
      :     :     :           :                                               +- *(46) Sort [SalesOrderId#5010 ASC NULLS FIRST, Material#5002 ASC NULLS FIRST, FREE_STOCK#216 DESC NULLS LAST], false, 0
      :     :     :           :                                                  +- *(46) Project [SalesOrderId#5010, MarsDc#4975, Material#5002, DonorPlant#2933, FREE_STOCK#216, (_we0#3693 / _we1#3694) AS CsPreSlSalesOrder#3692]
      :     :     :           :                                                     +- Window [sum(CsConfirmed#4990) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#3693, sum(CsOrdered#4989) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we1#3694], [SalesOrderId#5010]
      :     :     :           :                                                        +- *(45) Project [SalesOrderId#5010, MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, Material#5002, DonorPlant#2933, FREE_STOCK#216]
      :     :     :           :                                                           +- *(45) Filter (CountMaterialsInDonorPlant#3649L = cast(size(_we0#3670, true) as bigint))
      :     :     :           :                                                              +- Window [collect_set(Material#5002, 0, 0) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#3670], [SalesOrderId#5010]
      :     :     :           :                                                                 +- Window [count(Material#5002) windowspecdefinition(SalesOrderId#5010, DonorPlant#2933, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS CountMaterialsInDonorPlant#3649L], [SalesOrderId#5010, DonorPlant#2933]
      :     :     :           :                                                                    +- *(44) Sort [SalesOrderId#5010 ASC NULLS FIRST, DonorPlant#2933 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                       +- *(44) Project [SalesOrderId#5010, MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, Material#5002, DonorPlant#2933, FREE_STOCK#216]
      :     :     :           :                                                                          +- *(44) Filter ((isnotnull(SumAlertsForGRD#3630L) AND (SumAlertsForGRD#3630L = CountMaterialsInSalesorder#3612L)) AND (AlertForGRD#3558 = 1))
      :     :     :           :                                                                             +- Window [count(Material#5002) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS CountMaterialsInSalesorder#3612L, sum(cast(AnyGRDPlantAlert#3595 as bigint)) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS SumAlertsForGRD#3630L], [SalesOrderId#5010]
      :     :     :           :                                                                                +- *(43) Sort [SalesOrderId#5010 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                   +- Exchange hashpartitioning(SalesOrderId#5010, 32), true, [id=#1788]
      :     :     :           :                                                                                      +- Window [max(AlertForGRD#3558) windowspecdefinition(SalesOrderId#5010, Material#5002, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS AnyGRDPlantAlert#3595], [SalesOrderId#5010, Material#5002]
      :     :     :           :                                                                                         +- *(42) Sort [SalesOrderId#5010 ASC NULLS FIRST, Material#5002 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                            +- Exchange hashpartitioning(SalesOrderId#5010, Material#5002, 32), true, [id=#1783]
      :     :     :           :                                                                                               +- *(41) Project [SalesOrderId#5010, MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, Material#5002, DonorPlant#2933, FREE_STOCK#216, CASE WHEN ((((cast(FREE_STOCK#216 as double) - CsOrdered#4989) / cast(FORECAST_CASES_8_WEEK_BY_PER_DAY#3430 as double)) / cast(TMS#206 as double)) >= 0.5) THEN 1 ELSE 0 END AS AlertForGRD#3558]
      :     :     :           :                                                                                                  +- SortMergeJoin [DonorPlant#2933, Material#5002], [WAREHOUSE#201, MATERIAL_CODE#202], LeftOuter
      :     :     :           :                                                                                                     :- *(27) Sort [DonorPlant#2933 ASC NULLS FIRST, Material#5002 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                     :  +- Exchange hashpartitioning(DonorPlant#2933, Material#5002, 32), true, [id=#1775]
      :     :     :           :                                                                                                     :     +- *(26) Project [SalesOrderId#5010, MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, Material#5002, DonorPlant#2933]
      :     :     :           :                                                                                                     :        +- SortMergeJoin [MarsDc#4975], [SourcePlant#2932], LeftOuter
      :     :     :           :                                                                                                     :           :- *(23) Sort [MarsDc#4975 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                     :           :  +- Exchange hashpartitioning(MarsDc#4975, 32), true, [id=#1767]
      :     :     :           :                                                                                                     :           :     +- *(22) Project [SalesOrderId#5010, MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, Material#5002]
      :     :     :           :                                                                                                     :           :        +- *(22) Filter (((((isnotnull(CsPreSlSalesOrder#2786) AND isnotnull(OrderProcessingDate#4998)) AND (CsPreSlSalesOrder#2786 < 1.0)) AND MarsDc#4975 IN (RU32,RU38,RU37)) AND (OrderProcessingDate#4998 <= 20010)) AND (coalesce((_we0#2856 / _we1#2857), 0.0) >= 0.3))
      :     :     :           :                                                                                                     :           :           +- Window [sum(CutQtyPalletClean#2720) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we0#2856, sum(AGREED_ORDEREDQTY_PALLET#5032) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS _we1#2857], [SalesOrderId#5010]
      :     :     :           :                                                                                                     :           :              +- *(21) Project [MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, OrderProcessingDate#4998, Material#5002, SalesOrderId#5010, AGREED_ORDEREDQTY_PALLET#5032, CutQtyPalletClean#2720, CsPreSlSalesOrder#2786]
      :     :     :           :                                                                                                     :           :                 +- Window [avg(cast(_w0#2787 as bigint)) windowspecdefinition(SalesOrderId#5010, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS CsPreSlSalesOrder#2786], [SalesOrderId#5010]
      :     :     :           :                                                                                                     :           :                    +- *(20) Sort [SalesOrderId#5010 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                     :           :                       +- Exchange hashpartitioning(SalesOrderId#5010, 32), true, [id=#1754]
      :     :     :           :                                                                                                     :           :                          +- *(19) Project [MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, OrderProcessingDate#4998, Material#5002, SalesOrderId#5010, AGREED_ORDEREDQTY_PALLET#5032, CASE WHEN ((isnull(Allocation#5025) OR (AllocationAvailable#5026 = 0.0)) AND isnull(FlagPriceDisagreement#2451)) THEN CUT_QTY_PALLET#5031 END AS CutQtyPalletClean#2720, CASE WHEN (CsPreSl#4991 < 1.0) THEN 0 ELSE 1 END AS _w0#2787]
      :     :     :           :                                                                                                     :           :                             +- SortMergeJoin [Material#5002, PurchaseOrderId#5011], [MATERIAL_CODE#1795, PurchaseOrderId#2436], LeftOuter
      :     :     :           :                                                                                                     :           :                                :- *(12) Sort [Material#5002 ASC NULLS FIRST, PurchaseOrderId#5011 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                     :           :                                :  +- Exchange hashpartitioning(Material#5002, PurchaseOrderId#5011, 32), true, [id=#1255]
      :     :     :           :                                                                                                     :           :                                :     +- *(11) Project [MarsDc#4975, CsOrdered#4989, CsConfirmed#4990, CsPreSl#4991, OrderProcessingDate#4998, Material#5002, SalesOrderId#5010, PurchaseOrderId#5011, Allocation#5025, AllocationAvailable#5026, CUT_QTY_PALLET#5031, AGREED_ORDEREDQTY_PALLET#5032]
      :     :     :           :                                                                                                     :           :                                :        +- *(11) Filter isnotnull(SalesOrderId#5010)
      :     :     :           :                                                                                                     :           :                                :           +- *(11) ColumnarToRow
      :     :     :           :                                                                                                     :           :                                :              +- FileScan parquet [MarsDc#4975,CsOrdered#4989,CsConfirmed#4990,CsPreSl#4991,OrderProcessingDate#4998,Material#5002,SalesOrderId#5010,PurchaseOrderId#5011,Allocation#5025,AllocationAvailable#5026,CUT_QTY_PALLET#5031,AGREED_ORDEREDQTY_PALLET#5032] Batched: true, DataFilters: [isnotnull(SalesOrderId#5010)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00003-20230411131136265600000002/application/control..., PartitionFilters: [], PushedFilters: [IsNotNull(SalesOrderId)], ReadSchema: struct<MarsDc:string,CsOrdered:double,CsConfirmed:double,CsPreSl:double,OrderProcessingDate:date,...
      :     :     :           :                                                                                                     :           :                                +- *(18) Sort [MATERIAL_CODE#1795 ASC NULLS FIRST, PurchaseOrderId#2436 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                     :           :                                   +- *(18) Filter (isnotnull(FlagPriceDisagreement#2451) AND (FlagPriceDisagreement#2451 = 1))
      :     :     :           :                                                                                                     :           :                                      +- *(18) HashAggregate(keys=[MATERIAL_CODE#1795, BSTNK#717], functions=[max(FlagPriceDisagreement#2422)], output=[MATERIAL_CODE#1795, PurchaseOrderId#2436, FlagPriceDisagreement#2451])
      :     :     :           :                                                                                                     :           :                                         +- ReusedExchange [MATERIAL_CODE#1795, BSTNK#717, max#7248], Exchange hashpartitioning(MATERIAL_CODE#1795, BSTNK#717, 32), true, [id=#1235]
      :     :     :           :                                                                                                     :           +- *(25) Sort [SourcePlant#2932 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                     :              +- Exchange hashpartitioning(SourcePlant#2932, 32), true, [id=#1320]
      :     :     :           :                                                                                                     :                 +- *(24) Filter (SourcePlant#2932 IN (RU32,RU38,RU37) AND isnotnull(SourcePlant#2932))
      :     :     :           :                                                                                                     :                    +- *(24) Scan ExistingRDD[SourcePlant#2932,DonorPlant#2933]
      :     :     :           :                                                                                                     +- *(40) Sort [WAREHOUSE#201 ASC NULLS FIRST, MATERIAL_CODE#202 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                        +- Exchange hashpartitioning(WAREHOUSE#201, MATERIAL_CODE#202, 32), true, [id=#1389]
      :     :     :           :                                                                                                           +- *(39) Project [TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, CheckOverflow((promote_precision(accumulativeSum#3410) / 56.0000000000), DecimalType(38,10), true) AS FORECAST_CASES_8_WEEK_BY_PER_DAY#3430]
      :     :     :           :                                                                                                              +- *(39) Filter (isnotnull(rn#3420) AND (rn#3420 = 1))
      :     :     :           :                                                                                                                 +- Window [row_number() windowspecdefinition(WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#3420], [WAREHOUSE#201, MATERIAL_CODE#202, DAY#200], [OriginalDate#242 DESC NULLS LAST]
      :     :     :           :                                                                                                                    +- *(38) Sort [WAREHOUSE#201 ASC NULLS FIRST, MATERIAL_CODE#202 ASC NULLS FIRST, DAY#200 ASC NULLS FIRST, OriginalDate#242 DESC NULLS LAST], false, 0
      :     :     :           :                                                                                                                       +- *(38) Project [TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242, accumulativeSum#3410]
      :     :     :           :                                                                                                                          +- Window [sum(FORECAST_CASES#3401) windowspecdefinition(WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS accumulativeSum#3410], [WAREHOUSE#201, MATERIAL_CODE#202, DAY#200]
      :     :     :           :                                                                                                                             +- *(37) Sort [WAREHOUSE#201 ASC NULLS FIRST, MATERIAL_CODE#202 ASC NULLS FIRST, DAY#200 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                                                +- Exchange hashpartitioning(WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, 32), true, [id=#1375]
      :     :     :           :                                                                                                                                   +- *(36) HashAggregate(keys=[TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242], functions=[sum(CheckOverflow((promote_precision(FORECAST_CASES#433) / 7.0000000000), DecimalType(38,10), true))], output=[TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242, FORECAST_CASES#3401])
      :     :     :           :                                                                                                                                      +- Exchange hashpartitioning(TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242, 32), true, [id=#1371]
      :     :     :           :                                                                                                                                         +- *(35) HashAggregate(keys=[TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242], functions=[partial_sum(CheckOverflow((promote_precision(FORECAST_CASES#433) / 7.0000000000), DecimalType(38,10), true))], output=[TMS#206, FREE_STOCK#216, WAREHOUSE#201, MATERIAL_CODE#202, DAY#200, OriginalDate#242, sum#7252])
      :     :     :           :                                                                                                                                            +- *(35) Project [DAY#200, WAREHOUSE#201, MATERIAL_CODE#202, TMS#206, FREE_STOCK#216, OriginalDate#242, FORECAST_CASES#433]
      :     :     :           :                                                                                                                                               +- SortMergeJoin [WAREHOUSE#201, MATERIAL_CODE#202, MARS_WEEK_FOR_DEMAND#1239], [PLANT#426, MATERIAL_CODE#425, MARS_WEEK#428], LeftOuter, ((DAY#200 >= F_STARTDATE#430) AND (DAY#200 <= date_add(F_ENDDATE#431, -1)))
      :     :     :           :                                                                                                                                                  :- *(32) Sort [WAREHOUSE#201 ASC NULLS FIRST, MATERIAL_CODE#202 ASC NULLS FIRST, MARS_WEEK_FOR_DEMAND#1239 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                                                                  :  +- Exchange hashpartitioning(WAREHOUSE#201, MATERIAL_CODE#202, MARS_WEEK_FOR_DEMAND#1239, 32), true, [id=#1353]
      :     :     :           :                                                                                                                                                  :     +- BroadcastNestedLoopJoin BuildRight, Inner, ((OriginalDate#242 >= DAY#200) AND (OriginalDate#242 <= date_add(DAY#200, 56)))
      :     :     :           :                                                                                                                                                  :        :- *(30) Project [DAY#200, WAREHOUSE#201, MATERIAL_CODE#202, TMS#206, FREE_STOCK#216]
      :     :     :           :                                                                                                                                                  :        :  +- *(30) Filter ((isnotnull(rn#2937) AND (rn#2937 = 1)) AND isnotnull(DAY#200))
      :     :     :           :                                                                                                                                                  :        :     +- Window [row_number() windowspecdefinition(WAREHOUSE#201, MATERIAL_CODE#202, DAY#200 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#2937], [WAREHOUSE#201, MATERIAL_CODE#202], [DAY#200 DESC NULLS LAST]
      :     :     :           :                                                                                                                                                  :        :        +- *(29) Sort [WAREHOUSE#201 ASC NULLS FIRST, MATERIAL_CODE#202 ASC NULLS FIRST, DAY#200 DESC NULLS LAST], false, 0
      :     :     :           :                                                                                                                                                  :        :           +- Exchange hashpartitioning(WAREHOUSE#201, MATERIAL_CODE#202, 32), true, [id=#1337]
      :     :     :           :                                                                                                                                                  :        :              +- *(28) Project [DAY#200, WAREHOUSE#201, MATERIAL_CODE#202, TMS#206, FREE_STOCK#216]
      :     :     :           :                                                                                                                                                  :        :                 +- *(28) Filter (isnotnull(WAREHOUSE#201) AND isnotnull(MATERIAL_CODE#202))
      :     :     :           :                                                                                                                                                  :        :                    +- *(28) ColumnarToRow
      :     :     :           :                                                                                                                                                  :        :                       +- FileScan parquet [DAY#200,WAREHOUSE#201,MATERIAL_CODE#202,TMS#206,FREE_STOCK#216] Batched: true, DataFilters: [isnotnull(WAREHOUSE#201), isnotnull(MATERIAL_CODE#202)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/e2e/kpi..., PartitionFilters: [], PushedFilters: [IsNotNull(WAREHOUSE), IsNotNull(MATERIAL_CODE)], ReadSchema: struct<DAY:date,WAREHOUSE:string,MATERIAL_CODE:string,TMS:string,FREE_STOCK:decimal(16,2)>
      :     :     :           :                                                                                                                                                  :        +- BroadcastExchange IdentityBroadcastMode, [id=#1351]
      :     :     :           :                                                                                                                                                  :           +- *(31) Project [OriginalDate#242, concat(cast(MarsYear#243 as string), CASE WHEN (length(MarsPeriodName#247) = 2) THEN concat(P0, substring(MarsPeriodName#247, 2, 1)) ELSE MarsPeriodName#247 END, MarsWeekName#249) AS MARS_WEEK_FOR_DEMAND#1239]
      :     :     :           :                                                                                                                                                  :              +- *(31) Filter isnotnull(OriginalDate#242)
      :     :     :           :                                                                                                                                                  :                 +- *(31) ColumnarToRow
      :     :     :           :                                                                                                                                                  :                    +- FileScan parquet [OriginalDate#242,MarsYear#243,MarsPeriodName#247,MarsWeekName#249] Batched: true, DataFilters: [isnotnull(OriginalDate#242)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/core/un..., PartitionFilters: [], PushedFilters: [IsNotNull(OriginalDate)], ReadSchema: struct<OriginalDate:date,MarsYear:int,MarsPeriodName:string,MarsWeekName:string>
      :     :     :           :                                                                                                                                                  +- *(34) Sort [PLANT#426 ASC NULLS FIRST, MATERIAL_CODE#425 ASC NULLS FIRST, MARS_WEEK#428 ASC NULLS FIRST], false, 0
      :     :     :           :                                                                                                                                                     +- Exchange hashpartitioning(PLANT#426, MATERIAL_CODE#425, MARS_WEEK#428, 32), true, [id=#1362]
      :     :     :           :                                                                                                                                                        +- *(33) Project [MATERIAL_CODE#425, PLANT#426, MARS_WEEK#428, F_STARTDATE#430, F_ENDDATE#431, FORECAST_CASES#433]
      :     :     :           :                                                                                                                                                           +- *(33) Filter (((isnotnull(MATERIAL_CODE#425) AND isnotnull(MARS_WEEK#428)) AND isnotnull(F_STARTDATE#430)) AND isnotnull(PLANT#426))
      :     :     :           :                                                                                                                                                              +- *(33) ColumnarToRow
      :     :     :           :                                                                                                                                                                 +- FileScan parquet [MATERIAL_CODE#425,PLANT#426,MARS_WEEK#428,F_STARTDATE#430,F_ENDDATE#431,FORECAST_CASES#433] Batched: true, DataFilters: [isnotnull(MATERIAL_CODE#425), isnotnull(MARS_WEEK#428), isnotnull(F_STARTDATE#430), isnotnull(PL..., Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/e2e/kpi..., PartitionFilters: [], PushedFilters: [IsNotNull(MATERIAL_CODE), IsNotNull(MARS_WEEK), IsNotNull(F_STARTDATE), IsNotNull(PLANT)], ReadSchema: struct<MATERIAL_CODE:string,PLANT:string,MARS_WEEK:string,F_STARTDATE:date,F_ENDDATE:date,FORECAS...
      :     :     :           +- *(67) Sort [Material#5341 ASC NULLS FIRST, PositionNumber#5351 ASC NULLS FIRST, MarsDc#5314 ASC NULLS FIRST, SalesOrderId#5349 ASC NULLS FIRST], false, 0
      :     :     :              +- Exchange hashpartitioning(Material#5341, PositionNumber#5351, MarsDc#5314, SalesOrderId#5349, 32), true, [id=#1532]
      :     :     :                 +- *(66) Project [SalesOrderId#5349, Material#5341, PositionNumber#5351, MarsDc#5314, CASE WHEN isnotnull(TransitDate#4221) THEN concat(Перенести дату отгрузки на дату пополнения , cast(TransitDate#4221 as string), 
) ELSE Товара нет в плане производства на текущей неделе.
 END AS Alert#4559, 5 AS AlertPriority#4628]
      :     :     :                    +- *(66) Filter (((isnotnull(rn#4491) AND (rn#4491 = 1)) AND isnotnull(MarsDc#5314)) AND isnotnull(Material#5341))
      :     :     :                       +- Window [row_number() windowspecdefinition(SalesOrderId#5349, PositionNumber#5351, TransitDate#4221 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#4491], [SalesOrderId#5349, PositionNumber#5351], [TransitDate#4221 ASC NULLS FIRST]
      :     :     :                          +- *(65) Sort [SalesOrderId#5349 ASC NULLS FIRST, PositionNumber#5351 ASC NULLS FIRST, TransitDate#4221 ASC NULLS FIRST], false, 0
      :     :     :                             +- Exchange hashpartitioning(SalesOrderId#5349, PositionNumber#5351, 32), true, [id=#1523]
      :     :     :                                +- *(64) Project [MarsDc#5314, Material#5341, SalesOrderId#5349, PositionNumber#5351, TransitDate#4221]
      :     :     :                                   +- SortMergeJoin [Material#5341, MarsDc#5314], [GRD#1095, Delivery_LocationTo__FK#1094], LeftOuter, (FactPlanBillingDate#5336 < TransitDate#4221)
      :     :     :                                      :- *(52) Sort [Material#5341 ASC NULLS FIRST, MarsDc#5314 ASC NULLS FIRST], false, 0
      :     :     :                                      :  +- Exchange hashpartitioning(Material#5341, MarsDc#5314, 32), true, [id=#1452]
      :     :     :                                      :     +- *(51) Project [MarsDc#5314, FactPlanBillingDate#5336, Material#5341, SalesOrderId#5349, PositionNumber#5351]
      :     :     :                                      :        +- *(51) Filter (((((((((isnotnull(CsPreSl#5330) AND isnotnull(SlicePallet#5361)) AND isnotnull(Discontinue#5368)) AND isnotnull(OrderProcessingDate#5337)) AND (CsPreSl#5330 < 1.0)) AND (Discontinue#5368 = No)) AND (SlicePallet#5361 >= 0.1)) AND (OrderProcessingDate#5337 <= 20008)) AND isnotnull(PositionNumber#5351)) AND isnotnull(SalesOrderId#5349))
      :     :     :                                      :           +- *(51) ColumnarToRow
      :     :     :                                      :              +- FileScan parquet [MarsDc#5314,CsPreSl#5330,FactPlanBillingDate#5336,OrderProcessingDate#5337,Material#5341,SalesOrderId#5349,PositionNumber#5351,SlicePallet#5361,Discontinue#5368] Batched: true, DataFilters: [isnotnull(CsPreSl#5330), isnotnull(SlicePallet#5361), isnotnull(Discontinue#5368), isnotnull(Ord..., Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00003-20230411131136265600000002/application/control..., PartitionFilters: [], PushedFilters: [IsNotNull(CsPreSl), IsNotNull(SlicePallet), IsNotNull(Discontinue), IsNotNull(OrderProcessingDat..., ReadSchema: struct<MarsDc:string,CsPreSl:double,FactPlanBillingDate:date,OrderProcessingDate:date,Material:st...
      :     :     :                                      +- *(63) Sort [GRD#1095 ASC NULLS FIRST, Delivery_LocationTo__FK#1094 ASC NULLS FIRST], false, 0
      :     :     :                                         +- Exchange hashpartitioning(GRD#1095, Delivery_LocationTo__FK#1094, 32), true, [id=#1515]
      :     :     :                                            +- *(62) Project [GRD#1095, Delivery_LocationTo__FK#1094, date_add(Delivery_ActualGI__DTTM#1091, cast(TransitQIdays#1130 as int)) AS TransitDate#4221]
      :     :     :                                               +- *(62) BroadcastHashJoin [Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094, Tech#1742], [from2#1127, to4#1129, Tech#1125], Inner, BuildRight, isnotnull(date_add(Delivery_ActualGI__DTTM#1091, cast(TransitQIdays#1130 as int)))
      :     :     :                                                  :- *(62) Project [Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094, Tech#1742]
      :     :     :                                                  :  +- *(62) BroadcastHashJoin [GRD#1095], [MATNR#1138], Inner, BuildRight
      :     :     :                                                  :     :- *(62) Project [Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094]
      :     :     :                                                  :     :  +- BroadcastNestedLoopJoin BuildRight, Inner, (Delivery_ActualGI__DTTM#1091 >= FirstDateCurrentPeriod#1583)
      :     :     :                                                  :     :     :- *(54) HashAggregate(keys=[Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094], functions=[], output=[Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094])
      :     :     :                                                  :     :     :  +- Exchange hashpartitioning(Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094, 32), true, [id=#1462]
      :     :     :                                                  :     :     :     +- *(53) HashAggregate(keys=[Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094], functions=[], output=[Delivery_ActualGI__DTTM#1091, GRD#1095, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094])
      :     :     :                                                  :     :     :        +- *(53) Project [Delivery_ActualGI__DTTM#1091, Delivery_LocationFrom__FK#1093, Delivery_LocationTo__FK#1094, GRD#1095]
      :     :     :                                                  :     :     :           +- *(53) Filter (((((isnotnull(Division#1099) AND (Division#1099 = Petcare)) AND isnotnull(Delivery_ActualGI__DTTM#1091)) AND isnotnull(GRD#1095)) AND isnotnull(Delivery_LocationFrom__FK#1093)) AND isnotnull(Delivery_LocationTo__FK#1094))
      :     :     :                                                  :     :     :              +- *(53) ColumnarToRow
      :     :     :                                                  :     :     :                 +- FileScan parquet [Delivery_ActualGI__DTTM#1091,Delivery_LocationFrom__FK#1093,Delivery_LocationTo__FK#1094,GRD#1095,Division#1099] Batched: true, DataFilters: [isnotnull(Division#1099), (Division#1099 = Petcare), isnotnull(Delivery_ActualGI__DTTM#1091), is..., Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/control..., PartitionFilters: [], PushedFilters: [IsNotNull(Division), EqualTo(Division,Petcare), IsNotNull(Delivery_ActualGI__DTTM), IsNotNull(GR..., ReadSchema: struct<Delivery_ActualGI__DTTM:date,Delivery_LocationFrom__FK:string,Delivery_LocationTo__FK:stri...
      :     :     :                                                  :     :     +- BroadcastExchange IdentityBroadcastMode, [id=#1486]
      :     :     :                                                  :     :        +- *(57) Filter isnotnull(FirstDateCurrentPeriod#1583)
      :     :     :                                                  :     :           +- *(57) HashAggregate(keys=[], functions=[min(OriginalDate#242)], output=[FirstDateCurrentPeriod#1583])
      :     :     :                                                  :     :              +- Exchange SinglePartition, true, [id=#1481]
      :     :     :                                                  :     :                 +- *(56) HashAggregate(keys=[], functions=[partial_min(OriginalDate#242)], output=[min#7254])
      :     :     :                                                  :     :                    +- *(56) Project [OriginalDate#242]
      :     :     :                                                  :     :                       +- *(56) BroadcastHashJoin [MarsPeriodFullName#248], [MarsPeriodFullName#1351], Inner, BuildRight
      :     :     :                                                  :     :                          :- *(56) Project [OriginalDate#242, MarsPeriodFullName#248]
      :     :     :                                                  :     :                          :  +- *(56) Filter isnotnull(MarsPeriodFullName#248)
      :     :     :                                                  :     :                          :     +- *(56) ColumnarToRow
      :     :     :                                                  :     :                          :        +- FileScan parquet [OriginalDate#242,MarsPeriodFullName#248] Batched: true, DataFilters: [isnotnull(MarsPeriodFullName#248)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/core/un..., PartitionFilters: [], PushedFilters: [IsNotNull(MarsPeriodFullName)], ReadSchema: struct<OriginalDate:date,MarsPeriodFullName:string>
      :     :     :                                                  :     :                          +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true])), [id=#1475]
      :     :     :                                                  :     :                             +- *(55) Project [MarsPeriodFullName#1351]
      :     :     :                                                  :     :                                +- *(55) Filter ((isnotnull(OriginalDate#1345) AND (OriginalDate#1345 = 20005)) AND isnotnull(MarsPeriodFullName#1351))
      :     :     :                                                  :     :                                   +- *(55) ColumnarToRow
      :     :     :                                                  :     :                                      +- FileScan parquet [OriginalDate#1345,MarsPeriodFullName#1351] Batched: true, DataFilters: [isnotnull(OriginalDate#1345), (OriginalDate#1345 = 20005), isnotnull(MarsPeriodFullName#1351)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/core/un..., PartitionFilters: [], PushedFilters: [IsNotNull(OriginalDate), EqualTo(OriginalDate,2024-10-09), IsNotNull(MarsPeriodFullName)], ReadSchema: struct<OriginalDate:date,MarsPeriodFullName:string>
      :     :     :                                                  :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true])), [id=#1502]
      :     :     :                                                  :        +- *(60) Project [MATNR#1138, CASE WHEN (Brand#1149 = DREAMIES) THEN DRY WHEN (Technology#1152 = Dry) THEN DRY WHEN (Technology#1152 = Care & Treats) THEN DRY WHEN (Technology#1152 = Pouch) THEN WET WHEN isnull(Technology#1152) THEN null ELSE Others END AS Tech#1742]
      :     :     :                                                  :           +- *(60) Filter (((isnotnull(rn#1586) AND (rn#1586 = 1)) AND isnotnull(MATNR#1138)) AND isnotnull(CASE WHEN (Brand#1149 = DREAMIES) THEN DRY WHEN (Technology#1152 = Dry) THEN DRY WHEN (Technology#1152 = Care & Treats) THEN DRY WHEN (Technology#1152 = Pouch) THEN WET WHEN isnull(Technology#1152) THEN null ELSE Others END))
      :     :     :                                                  :              +- Window [row_number() windowspecdefinition(MATERIAL#1144, START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#1586], [MATERIAL#1144], [START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST]
      :     :     :                                                  :                 +- *(59) Sort [MATERIAL#1144 ASC NULLS FIRST, START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST], false, 0
      :     :     :                                                  :                    +- Exchange hashpartitioning(MATERIAL#1144, 32), true, [id=#1493]
      :     :     :                                                  :                       +- *(58) ColumnarToRow
      :     :     :                                                  :                          +- FileScan parquet [MATNR#1138,VMSTD#1139,0CREATEDON#1140,MATERIAL#1144,Brand#1149,Technology#1152,START_DATE#1172] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/domain_..., PartitionFilters: [], PushedFilters: [], ReadSchema: struct<MATNR:string,VMSTD:string,0CREATEDON:string,MATERIAL:string,Brand:string,Technology:string...
      :     :     :                                                  +- BroadcastExchange HashedRelationBroadcastMode(List(input[1, string, true], input[2, string, true], input[0, string, true])), [id=#1510]
      :     :     :                                                     +- *(61) Project [Tech#1125, from2#1127, to4#1129, TransitQIdays#1130]
      :     :     :                                                        +- *(61) Filter ((isnotnull(Tech#1125) AND isnotnull(from2#1127)) AND isnotnull(to4#1129))
      :     :     :                                                           +- FileScan csv [Tech#1125,from2#1127,to4#1129,TransitQIdays#1130] Batched: false, DataFilters: [isnotnull(Tech#1125), isnotnull(from2#1127), isnotnull(to4#1129)], Format: CSV, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00003-20230411131136265600000002/application/control..., PartitionFilters: [], PushedFilters: [IsNotNull(Tech), IsNotNull(from2), IsNotNull(to4)], ReadSchema: struct<Tech:string,from2:string,to4:string,TransitQIdays:string>
      :     :     +- *(76) Sort [A_SalesOrderId#4752 ASC NULLS FIRST, A_Material#4754 ASC NULLS FIRST, A_SoldTo#4753 ASC NULLS FIRST], false, 0
      :     :        +- *(76) Project [A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753, Alert#4894, 3 AS AlertPriority#4899]
      :     :           +- ObjectHashAggregate(keys=[A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753], functions=[collect_list(concat(T_SalesOrderId#4828,  (, cast(T_CsConfirmed#4832 as string),  cases)), 0, 0)], output=[A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753, Alert#4894])
      :     :              +- Exchange hashpartitioning(A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753, 32), true, [id=#1577]
      :     :                 +- ObjectHashAggregate(keys=[A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753], functions=[partial_collect_list(concat(T_SalesOrderId#4828,  (, cast(T_CsConfirmed#4832 as string),  cases)), 0, 0)], output=[A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753, buf#7256])
      :     :                    +- *(75) Project [A_SalesOrderId#4752, A_Material#4754, A_SoldTo#4753, T_SalesOrderId#4828, T_CsConfirmed#4832]
      :     :                       +- *(75) BroadcastHashJoin [A_SoldTo#4753, A_Material#4754], [T_SoldTo#4829, T_Material#4830], Inner, BuildLeft, ((NOT (A_SalesOrderId#4752 = T_SalesOrderId#4828) AND (A_OrderCreationDate#4751 >= T_OrderCreationDate#4827)) AND (date_add(A_FactPlanBillingDate#4750, 1) < T_FactPlanBillingDate#4826))
      :     :                          :- BroadcastExchange HashedRelationBroadcastMode(List(input[3, string, true], input[4, string, true])), [id=#1558]
      :     :                          :  +- *(72) Project [FactPlanBillingDate#25 AS A_FactPlanBillingDate#4750, OrderCreationDate#27 AS A_OrderCreationDate#4751, SalesOrderId#38 AS A_SalesOrderId#4752, SoldTo#9 AS A_SoldTo#4753, Material#30 AS A_Material#4754]
      :     :                          :     +- *(72) Filter ((((((((isnotnull(CsConfirmed#18) AND isnotnull(rn#4687)) AND isnotnull(Allocation#53)) AND isnotnull(OrderProcessingDate#26)) AND (rn#4687 = 1)) AND (Allocation#53 = true)) AND (CsConfirmed#18 = 0.0)) AND (OrderProcessingDate#26 >= 20003)) AND isnotnull(OrderCreationDate#27))
      :     :                          :        +- Window [row_number() windowspecdefinition(SalesOrderId#38, Material#30, SoldTo#9, FactPlanBillingDate#25 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#4687], [SalesOrderId#38, Material#30, SoldTo#9], [FactPlanBillingDate#25 DESC NULLS LAST]
      :     :                          :           +- *(71) Sort [SalesOrderId#38 ASC NULLS FIRST, Material#30 ASC NULLS FIRST, SoldTo#9 ASC NULLS FIRST, FactPlanBillingDate#25 DESC NULLS LAST], false, 0
      :     :                          :              +- Exchange hashpartitioning(SalesOrderId#38, Material#30, SoldTo#9, 32), true, [id=#1549]
      :     :                          :                 +- *(70) Project [SoldTo#9, CsConfirmed#18, FactPlanBillingDate#25, OrderProcessingDate#26, OrderCreationDate#27, Material#30, SalesOrderId#38, Allocation#53]
      :     :                          :                    +- *(70) Filter ((isnotnull(SoldTo#9) AND isnotnull(Material#30)) AND isnotnull(SalesOrderId#38))
      :     :                          :                       +- *(70) ColumnarToRow
      :     :                          :                          +- FileScan parquet [SoldTo#9,CsConfirmed#18,FactPlanBillingDate#25,OrderProcessingDate#26,OrderCreationDate#27,Material#30,SalesOrderId#38,Allocation#53] Batched: true, DataFilters: [isnotnull(SoldTo#9), isnotnull(Material#30), isnotnull(SalesOrderId#38)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00003-20230411131136265600000002/application/control..., PartitionFilters: [], PushedFilters: [IsNotNull(SoldTo), IsNotNull(Material), IsNotNull(SalesOrderId)], ReadSchema: struct<SoldTo:string,CsConfirmed:double,FactPlanBillingDate:date,OrderProcessingDate:date,OrderCr...
      :     :                          +- *(75) Project [FactPlanBillingDate#25 AS T_FactPlanBillingDate#4826, OrderCreationDate#27 AS T_OrderCreationDate#4827, SalesOrderId#38 AS T_SalesOrderId#4828, SoldTo#9 AS T_SoldTo#4829, Material#30 AS T_Material#4830, cast(CsConfirmed#18 as int) AS T_CsConfirmed#4832]
      :     :                             +- *(75) Filter ((((((isnotnull(CsConfirmed#18) AND isnotnull(rn#4763)) AND isnotnull(FactPlanBillingDate#25)) AND (rn#4763 = 1)) AND (FactPlanBillingDate#25 > 20009)) AND (CsConfirmed#18 > 0.0)) AND isnotnull(OrderCreationDate#27))
      :     :                                +- Window [row_number() windowspecdefinition(SalesOrderId#38, Material#30, SoldTo#9, FactPlanBillingDate#25 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#4763], [SalesOrderId#38, Material#30, SoldTo#9], [FactPlanBillingDate#25 DESC NULLS LAST]
      :     :                                   +- *(74) Sort [SalesOrderId#38 ASC NULLS FIRST, Material#30 ASC NULLS FIRST, SoldTo#9 ASC NULLS FIRST, FactPlanBillingDate#25 DESC NULLS LAST], false, 0
      :     :                                      +- Exchange hashpartitioning(SalesOrderId#38, Material#30, SoldTo#9, 32), true, [id=#1565]
      :     :                                         +- *(73) Project [SoldTo#9, CsConfirmed#18, FactPlanBillingDate#25, OrderCreationDate#27, Material#30, SalesOrderId#38]
      :     :                                            +- *(73) Filter ((isnotnull(Material#30) AND isnotnull(SoldTo#9)) AND isnotnull(SalesOrderId#38))
      :     :                                               +- *(73) ColumnarToRow
      :     :                                                  +- FileScan parquet [SoldTo#9,CsConfirmed#18,FactPlanBillingDate#25,OrderCreationDate#27,Material#30,SalesOrderId#38] Batched: true, DataFilters: [isnotnull(Material#30), isnotnull(SoldTo#9), isnotnull(SalesOrderId#38)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00003-20230411131136265600000002/application/control..., PartitionFilters: [], PushedFilters: [IsNotNull(Material), IsNotNull(SoldTo), IsNotNull(SalesOrderId)], ReadSchema: struct<SoldTo:string,CsConfirmed:double,FactPlanBillingDate:date,OrderCreationDate:date,Material:...
      :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true], input[1, string, true])), [id=#1591]
      :        +- *(77) Project [Material#125 AS Alert4_Material#4677, Customer#124 AS Alert4_Customer#4678, concat(Имеется превышение квоты на , cast(RemainingUnconfirmedQuota#134 as string),  cases.
, ТОП-4 клиента с наибольшей свободной квотой:
, Summary#160, 
) AS Alert#4636, 4 AS AlertPriority#4679]
      :           +- *(77) Filter (((((((isnotnull(ForecastVersionStartDate#122) AND isnotnull(ForecastVersionEndDate#123)) AND isnotnull(RemainingUnconfirmedQuota#134)) AND (ForecastVersionStartDate#122 <= 20005)) AND (ForecastVersionEndDate#123 > 20005)) AND (RemainingUnconfirmedQuota#134 > 0)) AND isnotnull(Material#125)) AND isnotnull(Customer#124))
      :              +- *(77) ColumnarToRow
      :                 +- FileScan parquet [ForecastVersionStartDate#122,ForecastVersionEndDate#123,Customer#124,Material#125,RemainingUnconfirmedQuota#134,Summary#160] Batched: true, DataFilters: [isnotnull(ForecastVersionStartDate#122), isnotnull(ForecastVersionEndDate#123), isnotnull(Remain..., Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-ct-00002-20231005150509504400000001/application/control_t..., PartitionFilters: [], PushedFilters: [IsNotNull(ForecastVersionStartDate), IsNotNull(ForecastVersionEndDate), IsNotNull(RemainingUncon..., ReadSchema: struct<ForecastVersionStartDate:date,ForecastVersionEndDate:date,Customer:string,Material:string,...
      +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, string, true])), [id=#1609]
         +- *(80) Project [MATERIAL#1144, Brand#1149]
            +- *(80) Filter (isnotnull(rn#1586) AND (rn#1586 = 1))
               +- Window [row_number() windowspecdefinition(MATERIAL#1144, START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#1586], [MATERIAL#1144], [START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST]
                  +- *(79) Sort [MATERIAL#1144 ASC NULLS FIRST, START_DATE#1172 DESC NULLS LAST, VMSTD#1139 DESC NULLS LAST, 0CREATEDON#1140 DESC NULLS LAST], false, 0
                     +- Exchange hashpartitioning(MATERIAL#1144, 32), true, [id=#1600]
                        +- *(78) Project [VMSTD#1139, 0CREATEDON#1140, MATERIAL#1144, Brand#1149, START_DATE#1172]
                           +- *(78) Filter isnotnull(MATERIAL#1144)
                              +- *(78) ColumnarToRow
                                 +- FileScan parquet [VMSTD#1139,0CREATEDON#1140,MATERIAL#1144,Brand#1149,START_DATE#1172] Batched: true, DataFilters: [isnotnull(MATERIAL#1144)], Format: Parquet, Location: InMemoryFileIndex[s3a://yac-sb-gen-rupn-data-00005-20230908143357373700000001/application/domain_..., PartitionFilters: [], PushedFilters: [IsNotNull(MATERIAL)], ReadSchema: struct<VMSTD:string,0CREATEDON:string,MATERIAL:string,Brand:string,START_DATE:date>